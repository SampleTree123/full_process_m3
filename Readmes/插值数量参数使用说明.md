# 插值数量参数使用说明

## 📋 功能说明

新增了 `--num_interpolations` 参数，用于控制在两张图像之间生成多少个插值帧。

### 默认行为
- **默认值**: 9 个插值图像
- **总图像序列**: 11 张（左图 + 9个插值 + 右图）
- **插值权重**: 自动均匀分布

## 🔧 使用方法

### 命令行参数

```bash
python main.py \
    --input_dirs /path/to/images1 /path/to/images2 \
    --output_dir output \
    --sample_n 10 \
    --num_interpolations 9  # 新增参数
```

### 参数说明

| 参数 | 类型 | 默认值 | 说明 |
|-----|------|--------|------|
| `--num_interpolations` | int | 9 | 插值图像数量，控制在两张图之间生成多少个插值帧 |

## 📊 不同插值数量的效果

### 示例 1: 默认配置（9个插值）

```bash
python main.py --input_dirs ./images --sample_n 5 --num_interpolations 9
```

**生成的图像序列**:
```
左图 (w1=1.0, w2=0.0)
  ↓
插值1 (w1=0.9, w2=0.1)
插值2 (w1=0.8, w2=0.2)
插值3 (w1=0.7, w2=0.3)
插值4 (w1=0.6, w2=0.4)
插值5 (w1=0.5, w2=0.5)  ← 中点
插值6 (w1=0.4, w2=0.6)
插值7 (w1=0.3, w2=0.7)
插值8 (w1=0.2, w2=0.8)
插值9 (w1=0.1, w2=0.9)
  ↓
右图 (w1=0.0, w2=1.0)

总计: 11 张图像
```

### 示例 2: 少量插值（4个）

```bash
python main.py --input_dirs ./images --sample_n 5 --num_interpolations 4
```

**生成的图像序列**:
```
左图 (w1=1.0, w2=0.0)
  ↓
插值1 (w1=0.8, w2=0.2)
插值2 (w1=0.6, w2=0.4)
插值3 (w1=0.4, w2=0.6)
插值4 (w1=0.2, w2=0.8)
  ↓
右图 (w1=0.0, w2=1.0)

总计: 6 张图像
```

### 示例 3: 大量插值（19个）

```bash
python main.py --input_dirs ./images --sample_n 5 --num_interpolations 19
```

**生成的图像序列**:
```
左图 (w1=1.0, w2=0.0)
  ↓
插值1 (w1=0.95, w2=0.05)
插值2 (w1=0.90, w2=0.10)
...
插值10 (w1=0.50, w2=0.50)  ← 中点
...
插值19 (w1=0.05, w2=0.95)
  ↓
右图 (w1=0.0, w2=1.0)

总计: 21 张图像
```

## 🎯 应用场景

### 场景 1: 高帧率视频生成
**需求**: 生成平滑的相机运动视频  
**建议**: `--num_interpolations 19` 或更多  
**效果**: 每秒30帧，可生成约0.7秒的视频

### 场景 2: 普通视频生成
**需求**: 标准质量的视频输出  
**建议**: `--num_interpolations 9` (默认)  
**效果**: 每秒30帧，可生成约0.37秒的视频

### 场景 3: 快速原型测试
**需求**: 快速验证处理流程  
**建议**: `--num_interpolations 4`  
**效果**: 减少处理时间，快速查看结果

### 场景 4: 极致平滑过渡
**需求**: 电影级别的平滑过渡  
**建议**: `--num_interpolations 29` 或更多  
**效果**: 极其平滑的相机运动

## 💡 性能考虑

### 处理时间估算

假设单张图像超分处理需要 2 秒：

| 插值数量 | 每对图像生成数 | 预估处理时间 |
|---------|--------------|-------------|
| 4 | 4 张 | ~8 秒 |
| 9 (默认) | 9 张 | ~18 秒 |
| 19 | 19 张 | ~38 秒 |
| 29 | 29 张 | ~58 秒 |

### 磁盘空间估算

假设每张超分图像约 2 MB：

| 插值数量 | 每对图像磁盘占用 |
|---------|---------------|
| 4 | ~8 MB |
| 9 (默认) | ~18 MB |
| 19 | ~38 MB |
| 29 | ~58 MB |

## 📐 插值权重计算公式

```python
# 对于 num_interpolations = N，生成 N 个插值图像
for i in range(1, N + 1):
    w1 = (N + 1 - i) / (N + 1)  # 左图权重（递减）
    w2 = i / (N + 1)             # 右图权重（递增）
    
    # 插值参数
    interp_yaw = w1 * left_yaw + w2 * right_yaw
    interp_pitch = w1 * left_pitch + w2 * right_pitch
    # ... 其他参数类似
```

### 权重示例

**N=4 时**:
```
i=1: w1=0.8, w2=0.2
i=2: w1=0.6, w2=0.4
i=3: w1=0.4, w2=0.6
i=4: w1=0.2, w2=0.8
```

**N=9 时**:
```
i=1: w1=0.9, w2=0.1
i=2: w1=0.8, w2=0.2
...
i=5: w1=0.5, w2=0.5  ← 中点
...
i=9: w1=0.1, w2=0.9
```

## 🔄 完整使用示例

### 示例 1: 固定采样模式

```bash
# 处理 10 对图像，每对生成 9 个插值帧
python main.py \
    --input_dirs /data/panoramas1 /data/panoramas2 \
    --output_dir output \
    --sample_n 10 \
    --num_interpolations 9 \
    --api_version original
```

### 示例 2: 目标数量模式

```bash
# 持续处理直到获得 100 个有效的 yaw_interval，每对生成 4 个插值帧
python main.py \
    --input_dirs /data/panoramas1 /data/panoramas2 \
    --output_dir output \
    --target_n 100 \
    --num_interpolations 4 \
    --api_version original
```

### 示例 3: 高质量输出

```bash
# 生成高质量的插值序列，19 个插值帧
python main.py \
    --input_dirs /data/high_quality_panos \
    --output_dir output_hq \
    --sample_n 5 \
    --num_interpolations 19 \
    --random_seed 42
```

## 🛠️ API 接口使用

如果直接调用 API，也可以使用此参数：

```python
import requests

# 调用插值生成 API
response = requests.post('http://localhost:5000/generate_interpolated_images', json={
    'split_results': split_results,
    'panorama1_path': '/path/to/pano1.jpg',
    'panorama2_path': '/path/to/pano2.jpg',
    'group_id': 1,
    'num_interpolations': 19  # 自定义插值数量
})
```

## ⚠️ 注意事项

1. **最小值**: 建议 `num_interpolations >= 1`，否则没有插值图像
2. **最大值**: 理论上无限制，但考虑到：
   - 处理时间线性增长
   - 磁盘空间需求增加
   - 超过 50 个插值可能收益递减
3. **奇偶性**: 建议使用奇数，这样会有一个精确的中点插值（w1=0.5, w2=0.5）

## 📝 输出文件结构

```
output/
  └── group_0001/
      ├── preprocess/          # 预处理后的图像对
      ├── osediff/             # 超分后的图像对
      ├── interpolated/        # 插值图像（数量 = num_interpolations）
      ├── interpolated_sr/     # 超分后的插值图像
      └── descriptions/        # 描述文件
```

## 🎬 视频生成建议

如果要生成视频，推荐配置：

| 视频类型 | 推荐插值数 | 帧率 | 说明 |
|---------|-----------|------|------|
| 快速预览 | 4 | 15 fps | 快速查看效果 |
| 标准视频 | 9 | 30 fps | 平衡质量和性能 |
| 高质量视频 | 19 | 60 fps | 平滑过渡 |
| 电影级 | 29+ | 60 fps | 极致平滑 |

---

**版本**: 1.0  
**更新日期**: 2026-02-11  
**兼容性**: full_process_m3 所有版本
